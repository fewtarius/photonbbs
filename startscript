#!/bin/bash

export PATH="/bin:/sbin:/usr/bin:/usr/sbin:/doorexec:/usr/doorexec:$PATH"

###
### Set up the PhotonBBS data files to be persistent.
###

# Always ensure data is linked to appdata
if [ -d '/opt/photonbbs/data' ]
then
  if [ ! -e '/appdata/.migrated' ]
  then
    mv /opt/photonbbs/data/* /appdata
  fi
  rm -rf /opt/photonbbs/data
  ln -sf /appdata /opt/photonbbs/data
  touch /appdata/.migrated
fi

# Ensure photonmud data directory exists and has base files
if [ ! -d '/appdata/photonmud' ]
then
  mkdir -p /appdata/photonmud
  # Copy default data files from the image if available
  if [ -d '/tmp/photonbbs-data/photonmud' ]
  then
    cp -r /tmp/photonbbs-data/photonmud/* /appdata/photonmud/
  fi
fi
chown -R nobody:nobody /appdata/photonmud 2>/dev/null || true

# Always ensure doorexec is properly linked
if [ ! -d '/appdata/doorexec' ] && [ -d '/opt/photonbbs/doorexec' ]
then
  mv /opt/photonbbs/doorexec /appdata
fi
rm -rf /opt/photonbbs/doorexec
ln -sf /appdata/doorexec /opt/photonbbs/doorexec
chmod +x /appdata/doorexec/*.sh 2>/dev/null || true
chown -R nobody:nobody /appdata/doorexec 2>/dev/null || true

# Always ensure doors directory is properly linked
if [ ! -d '/appdata/doors' ] && [ -d '/opt/photonbbs/doors' ]
then
  mv /opt/photonbbs/doors /appdata
fi
rm -rf /opt/photonbbs/doors
ln -sf /appdata/doors /opt/photonbbs/doors
chown -R nobody:nobody /appdata/doors 2>/dev/null || true

###
### Create the nodeinfo directory, this is needed for doors to work.
###

mkdir -p /dev/shm/photonbbs/doors/nodes
# Ensure the BBS user can write to this directory
chown -R nobody:nobody /dev/shm/photonbbs
chmod -R 777 /dev/shm/photonbbs

# Ensure photonmud transient directory exists with proper permissions
mkdir -p /dev/shm/photonmud/room_players
chown -R nobody:nobody /dev/shm/photonmud
chmod -R 777 /dev/shm/photonmud

###
### Link the node info directory into the doors directory passed to dosemu
### to make it available to the doors.
###

# Always recreate this link
rm -f /appdata/doors/nodes
ln -sf /dev/shm/photonbbs/doors/nodes /appdata/doors/nodes

###
### Dosemu
###

mkdir -p /appdata/.dosemu/drive_c
mkdir -p /appdata/.dosemu/drives

# Always recreate DOSEMU drive links
rm -f /appdata/.dosemu/drives/d
ln -sf /usr/share/dosemu/drive_z /appdata/.dosemu/drives/d

rm -f /appdata/.dosemu/drives/c
ln -sf /appdata/.dosemu/drive_c /appdata/.dosemu/drives/c

###
### Link /opt/photonbbs/.dosemu to /appdata/.dosemu
###

# Always recreate .dosemu link
rm -rf /opt/photonbbs/.dosemu
ln -sf /appdata/.dosemu /opt/photonbbs/.dosemu

###
### Create DOSEMU C: drive symlinks for door games
###

# Always recreate doors link for DOSEMU
rm -f /appdata/.dosemu/drive_c/doors
ln -sf /appdata/doors /appdata/.dosemu/drive_c/doors

# Always recreate nodeinfo link for DOSEMU drop files
rm -f /appdata/.dosemu/drive_c/nodeinfo
ln -sf /dev/shm/photonbbs/doors/nodes /appdata/.dosemu/drive_c/nodeinfo

###
### Set DOSEMU directory permissions for nobody user
###

chown -R nobody:nobody /appdata/.dosemu 2>/dev/null || true
chmod -R 755 /appdata/.dosemu 2>/dev/null || true

###
### Move /etc/default/photonbbs to /appdata
###

mkdir -p /appdata/default
if [ -f '/etc/default/photonbbs' ] && [ ! -h '/etc/default/photonbbs' ]
then
  mv /etc/default/photonbbs /appdata/default/
fi
rm -f /etc/default/photonbbs
ln -sf /appdata/default/photonbbs /etc/default/photonbbs

### The BBS won't manage this since it's a link
chown -R nobody:nobody /appdata /opt/photonbbs/data

# Start PhotonBBS daemon (handles telnet connections and TTY management)

/opt/photonbbs/photonbbs
exit 0
