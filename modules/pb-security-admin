#!/usr/bin/perl
#
#  Photon BBS Security Administration Module
#  (C) 2025 Fewtarius
#
#  Provides sysop commands for managing IP bans, viewing security logs,
#  and monitoring failed login attempts.
#
#  SECURITY LEVEL REQUIRED: sec_sysop (default 500)

# No 'use strict' - this module shares global namespace with pb-framework

# Security dashboard - show recent attacks and bans
sub security_dashboard {
    
    # Check sysop permissions
    unless ($info{'security'} >= $config{'sec_sysop'}) {
        main::writeline($config{'errorcolor'}."Access denied. Sysop privileges required.".$RST, 1);
        return;
    }
    
    main::writeline($CLR, 0);
    main::writeline($config{'themecolor'}."\nSecurity Dashboard".$RST, 1);
    main::writeline("", 1);
    
    # Show currently banned IPs
    my @bans = main::get_banned_ips();
    main::writeline($config{'datacolor'}."Banned IPs".$RST, 1);
    if (@bans) {
        foreach my $ban (@bans) {
            my $ip = $ban->{ip};
            my $reason = $ban->{reason};
            my $expires = $ban->{expires} > 0 ? 
                scalar(localtime($ban->{expires})) : "Never";
            main::writeline("  ".$config{'usercolor'}.$ip.$config{'themecolor'}." ... ".$config{'datacolor'}.$reason.$config{'themecolor'}." (expires: ".$expires.")".$RST, 1);
        }
    } else {
        main::writeline("  ".$config{'datacolor'}."No banned IPs".$RST, 1);
    }
    main::writeline("", 1);
    
    # Show recent failed login attempts
    my @attempts = main::get_failed_login_stats(20);
    main::writeline($config{'datacolor'}."Recent Failed Logins".$RST, 1);
    if (@attempts) {
        foreach my $attempt (@attempts) {
            my $ago = format_time_ago($attempt->{ago});
            my $ip = $attempt->{ip};
            my $user = $attempt->{username};
            main::writeline("  ".$config{'themecolor'}.$ago.$config{'usercolor'}." ... ".$config{'datacolor'}.$ip.$config{'themecolor'}." ... ".$user.$RST, 1);
        }
    } else {
        main::writeline("  ".$config{'datacolor'}."No recent failed logins".$RST, 1);
    }
    main::writeline("", 1);
    
    # Show statistics
    my $total_bans = scalar(@bans);
    my $total_failures = scalar(@attempts);
    main::writeline($config{'datacolor'}."Statistics".$RST, 1);
    main::writeline("  ".$config{'themecolor'}."Active bans: ".$config{'usercolor'}.$total_bans.$RST, 1);
    main::writeline("  ".$config{'themecolor'}."Recent failed logins: ".$config{'usercolor'}.$total_failures.$RST, 1);
    main::writeline("", 1);
    
    main::writeline($config{'datacolor'}."Commands".$RST, 1);
    main::writeline("  ".$config{'promptcolor'}."B".$config{'themecolor'}." ... ".$config{'usercolor'}."Ban IP", 1);
    main::writeline("  ".$config{'promptcolor'}."U".$config{'themecolor'}." ... ".$config{'usercolor'}."Unban IP", 1);
    main::writeline("  ".$config{'promptcolor'}."W".$config{'themecolor'}." ... ".$config{'usercolor'}."Manage Whitelist", 1);
    main::writeline("  ".$config{'promptcolor'}."R".$config{'themecolor'}." ... ".$config{'usercolor'}."Refresh", 1);
    main::writeline("  ".$config{'promptcolor'}."Q".$config{'themecolor'}." ... ".$config{'usercolor'}."Quit", 1);
    main::writeline("", 1);
    main::writeline($config{'promptcolor'}."Enter command: ".$RST);
    
    my $cmd = uc(main::getline('text', 1, "", 1));
    
    if ($cmd eq 'B') {
        ban_ip_command();
    } elsif ($cmd eq 'U') {
        unban_ip_command();
    } elsif ($cmd eq 'W') {
        manage_whitelist();
    } elsif ($cmd eq 'R') {
        security_dashboard();
    } elsif ($cmd eq 'Q') {
        return;
    } else {
        security_dashboard();
    }
}

# Ban an IP address
sub ban_ip_command {
    
    main::writeline("", 1);
    main::writeline($config{'themecolor'}."\1".$RST, 1);
    main::writeline($config{'promptcolor'}."Enter IP address or pattern to ban: ".$RST);
    my $ip = main::getline('text', 50, "", 1);
    
    return security_dashboard() unless $ip;
    
    main::writeline($config{'promptcolor'}."Enter reason (optional): ".$RST);
    my $reason = main::getline('text', 100, "", 1);
    $reason ||= "Manually banned by sysop";
    
    main::writeline($config{'promptcolor'}."Ban duration in seconds (0 for permanent): ".$RST);
    my $duration = main::getline('text', 10, "", 1);
    $duration = 0 unless $duration =~ /^\d+$/;
    
    my $expires = ($duration > 0) ? (time() + $duration) : 0;
    
    if (main::manual_ban_ip($ip, $reason, $expires)) {
        main::writeline($config{'systemcolor'}."✓ Successfully banned IP: $ip".$RST, 1);
        main::writeline($config{'datacolor'}."Reason: $reason".$RST, 1);
        main::writeline($config{'datacolor'}."Expires: " . 
            ($expires > 0 ? scalar(localtime($expires)) : "Never") . $RST, 1);
    } else {
        main::writeline($config{'errorcolor'}."✗ Failed to ban IP: $ip".$RST, 1);
    }
    
    main::writeline("", 1);
    main::writeline($config{'promptcolor'}."Press any key to continue...".$RST);
    main::waitkey();
    
    security_dashboard();
}

# Unban an IP address
sub unban_ip_command {
    
    main::writeline("", 1);
    main::writeline($config{'themecolor'}."\1".$RST, 1);
    main::writeline($config{'promptcolor'}."Enter IP address to unban: ".$RST);
    my $ip = main::getline('text', 50, "", 1);
    
    return security_dashboard() unless $ip;
    
    if (unban_ip($ip)) {
        main::writeline($config{'systemcolor'}."✓ Successfully unbanned IP: $ip".$RST, 1);
    } else {
        main::writeline($config{'errorcolor'}."✗ IP not found in ban list: $ip".$RST, 1);
    }
    
    main::writeline("", 1);
    main::writeline($config{'promptcolor'}."Press any key to continue...".$RST);
    main::waitkey();
    
    security_dashboard();
}

# Manage IP whitelist
sub manage_whitelist {
    
    main::writeline($CLR, 0);
    main::writeline($config{'systemcolor'}."╔========================================================================╗", 1);
    main::writeline($config{'systemcolor'}."║                  ".$config{'usercolor'}."IP WHITELIST MANAGEMENT".$config{'systemcolor'}."                           ║", 1);
    main::writeline($config{'systemcolor'}."╚========================================================================╝".$RST, 1);
    main::writeline("", 1);
    
    my $whitelist_file = "$config{'home'}$config{'data'}/whitelist_ip";
    
    main::writeline($config{'themecolor'}."Whitelist Status: " . 
        ($config{'sec_whitelist_enabled'} ? 
            $config{'systemcolor'}."ENABLED" : 
            $config{'errorcolor'}."DISABLED") . $RST, 1);
    main::writeline("", 1);
    
    # Show current whitelist
    main::writeline($config{'themecolor'}."\1".$RST, 1);
    if (-e $whitelist_file && open(my $fh, '<', $whitelist_file)) {
        my $count = 0;
        while (my $line = <$fh>) {
            chomp $line;
            next if $line =~ /^#/;
            next unless $line =~ /\S/;
            main::writeline($config{'datacolor'}."  $line".$RST, 1);
            $count++;
        }
        close($fh);
        main::writeline($config{'datacolor'}."Total: $count entries".$RST, 1) if $count > 0;
        main::writeline($config{'datacolor'}."No whitelisted IPs".$RST, 1) if $count == 0;
    } else {
        main::writeline($config{'datacolor'}."No whitelist file found".$RST, 1);
    }
    main::writeline("", 1);
    
    main::writeline($config{'promptcolor'}."Commands: (A)dd IP, (R)emove IP, (E)nable/Disable, (B)ack".$RST, 1);
    main::writeline($config{'promptcolor'}."Enter command: ".$RST);
    
    my $cmd = uc(main::getline('text', 1, "", 1));
    
    if ($cmd eq 'A') {
        main::writeline($config{'promptcolor'}."Enter IP to whitelist: ".$RST);
        my $ip = main::getline('text', 50, "", 1);
        if ($ip && open(my $out, '>>', $whitelist_file)) {
            print $out "$ip\n";
            close($out);
            main::writeline($config{'systemcolor'}."✓ Added $ip to whitelist".$RST, 1);
            main::waitkey();
        }
        manage_whitelist();
    } elsif ($cmd eq 'E') {
        main::writeline($config{'systemcolor'}."Note: Whitelist enable/disable requires editing pb-defaults config file.".$RST, 1);
        main::writeline($config{'datacolor'}."Set sec_whitelist_enabled = '1' to enable".$RST, 1);
        main::waitkey();
        manage_whitelist();
    } elsif ($cmd eq 'B') {
        security_dashboard();
    } else {
        manage_whitelist();
    }
}

# Format time ago in human-readable format
sub format_time_ago {
    my ($seconds) = @_;
    
    return "Just now" if $seconds < 60;
    
    my $minutes = int($seconds / 60);
    return "${minutes}m ago" if $minutes < 60;
    
    my $hours = int($minutes / 60);
    return "${hours}h ago" if $hours < 24;
    
    my $days = int($hours / 24);
    return "${days}d ago";
}

return 1;
